getHotelListLinks(30, cityIds[3]) %>% lapply( function(url) getHotelLinksByPage(url, cityIds[3]))
getHotelListLinks(30, cityIds[3]) %>% lapply( function(url) getHotelLinksByPage(url, cityIds[3])) %>% unlist
getHotelListLinks(30, cityIds[3]) %>% lapply( function(url) getHotelLinksByPage(url, cityIds[3])) %>% unlist %>% class
links = sapply(cityIds, function(cityId){
totalOffset(cityId) %>%
getHotelListLinks(cityId) %>%
lapply(function(url) getHotelLinksByPage(url, cityId)) %>%
unlist()
})
rm(url)
Reduce(function(x,y) length(x) + length(y), links)
Reduce(`+`, links)
Reduce(`+`(length(x), length(y)), links)
Reduce(function(x) `+`(length(x), length(y)), links)
lapply(links, length)
lapply(links, length) %>% sum
lapply(links, length) %>% unlist
lapply(links, length) %>% unlist %>% sum
source('~/russia-clust/tripadvisor-methods.R')
require(rvest)
require(dplyr)
getNodesAttribute <- function(url, xpath, attribute) {
url %>%
read_html() %>%
htm_nodes(xpath = xpath) %>%
html_attr(attribute) %>%
return()
}
cityId
getNodesAttribute(paste0("https://tripadvisor.ru/Hotels-g", cityIds[1]), xpath = "//*[@class = 'pageNum last taLnk']", attribute = "data-offset")
getNodesAttribute <- function(url, xpath, attribute) {
url %>%
read_html() %>%
html_nodes(xpath = xpath) %>%
html_attr(attribute) %>%
return()
}
getNodesAttribute(paste0("https://tripadvisor.ru/Hotels-g", cityIds[1]), xpath = "//*[@class = 'pageNum last taLnk']", attribute = "data-offset")
source('~/russia-clust/tripadvisor-methods.R')
totalOffset(cityIds[1])
totalOffset(cityIds[1]) %>% system.time()
system.time(totalOffset(cityIds[1]))
totalOffsetOld <- function(cityId) {
#We check last pagination number on the page for "data-offset" property
offset <- paste0("https://tripadvisor.ru/Hotels-g", cityId) %>%
read_html() %>%
html_nodes(xpath = "//*[@class = 'pageNum last taLnk']") %>%
html_attr("data-offset") %>%
as.numeric()
#If there is no pagination, which is possible, return 30
return(
ifelse(length(offset) > 0, offset, 30)
)
}
system.time(totalOffsetOld(cityIds[1]))
system.time(totalOffset(cityIds[1]))
source('~/russia-clust/tripadvisor-methods.R')
rm(totalOffsetOld())
rm(totalOffsetOld
)
source('~/russia-clust/tripadvisor-methods.R')
getHotelListLinks(180, cityIds[1])
getHotelListLinks(180, cityIds[1])[1]
getHotelListLinks(180, cityIds[1])[1] %>% getHotelLinksByPage(cityIds[1])
getHotelLinksByPage("https://tripadvisor.ru/Hotels-g298536-oa0", cityIds[1])
system.time(getHotelLinksByPage("https://tripadvisor.ru/Hotels-g298536-oa0", cityIds[1]))
getHotelLinksByPageOld <- function(url, cityId) {
read_html(url) %>%
html_nodes(xpath = "//*[@class='listing easyClear  p13n_imperfect ']") %>%
html_attr("data-locationid") %>%
sapply(function(hotelId) paste0("https://tripadvisor.ru/Hotels-g", cityId, "-d", hotelId))
}
system.time(getHotelLinksByPageOld("https://tripadvisor.ru/Hotels-g298536-oa0", cityIds[1]))
system.time(getHotelLinksByPage("https://tripadvisor.ru/Hotels-g298536-oa0", cityIds[1]))
system.time(getHotelLinksByPage("https://tripadvisor.ru/Hotels-g298536-oa0", cityIds[1]))
system.time(getHotelLinksByPageOld("https://tripadvisor.ru/Hotels-g298536-oa0", cityIds[1]))
rm(getHotelLinksByPageOld())
rm(getHotelLinksByPageOld
)
source('~/russia-clust/tripadvisor-methods.R')
source('~/russia-clust/tripadvisor-methods.R')
links[3]
names(links[3])
name(links[3])
names(links[3])
links.test = links
names(links.test[3]) = cityId[3]
names(links.test[3]) = cityIds[3]
names(links.test[3])
links.test[3] %>% class
links.test[3] %>% names()
links.test[[3]] %>% names()
links.test[[3]]
links.test[[3]] %>% class
getHotelLinksByPage("https://tripadvisor.ru/Hotels-g298536-oa0", cityIds[1])
getHotelLinksByPage("https://tripadvisor.ru/Hotels-g298536-oa0", cityIds[1]) %>% class()
getHotelLinksByPage("https://tripadvisor.ru/Hotels-g298536-oa0", cityIds[1]) %>% as.list()
?setwd
getwd()
require(functional)
install.packages("functional")
require(functional)
Curry(getHotelLinksByPage(), cityIds[1])
Curry(getHotelLinksByPage(), cityId = cityIds[1])("https://tripadvisor.ru/Hotels-g298536-oa0")
Curry(getHotelLinksByPage(), cityIds[1])("https://tripadvisor.ru/Hotels-g298536-oa0")
Curry(getHotelLinksByPage(), cityIds[1])()
x <- Curry(getHotelLinksByPage(), cityIds[1])
x("https://tripadvisor.ru/Hotels-g298536-oa0")
x
body(x)
x <- Curry(getHotelLinksByPage, cityIds[1])
body(x)
x("https://tripadvisor.ru/Hotels-g298536-oa0")
x <- Curry(`*`, 2)
x(2)
x(4)
x <- Curry(getHotelLinksByPage, cityId = cityIds[1])
x
x("https://tripadvisor.ru/Hotels-g298536-oa0")
car <- function(list) list[[1]]
cdr <- function(list) list[2:length(list)]
cadr <- Compose(cdr, car)
cadr
cadr(c(1,2,3,4))
cadr(c(1,2,3,4,5))
car <- function(list) list[[2]]
cadr <- Compose(cdr, car)
cadr(c(1,2,3,4,5))
cadr(c(1,2,3,4))
rm(cadr, car, cdr)
rm(x)
plusFive = function(x) x + 5
multTwo = function(x) x * 2
Compose(plusFive, multTwo)
Compose(plusFive, multTwo)(2)
rm(plusFive, multTwo)
getAllHotelLinks <- function(cityId) {
this.getHotelListLinks <- Curry(getHotelListLinks, cityId = cityId)
this.getHotelLinksByPage <- Curry(getHotelLinksByPage, cityId = cityId)
outputFun = Compose(totalOffset, this.getHotelListLinks, this.getHotelLinksByPage)
return(outputFun(cityId))
}
getAllHotelLinks(cityIds[3])
system.time(getAllHotelLinks(cityIds[3]))
system.time(getAllHotelLinks(cityIds[3]))
system.time(getAllHotelLinks(cityIds[3]))
system.time(getAllHotelLinks(cityIds[3]))
system.time(getAllHotelLinks(cityIds[3])) %>% str
system.time(getAllHotelLinks(cityIds[3]))[3]
system.time(getAllHotelLinks(cityIds[3]))[3]
lapply(cityIds[3], function(cityId){
totalOffset(cityId) %>%
getHotelListLinks(cityId) %>%
lapply(function(url) getHotelLinksByPage(url, cityId)) %>%
unlist()
})
system.time(lapply(cityIds[3], function(cityId){
totalOffset(cityId) %>%
getHotelListLinks(cityId) %>%
lapply(function(url) getHotelLinksByPage(url, cityId)) %>%
unlist()
}))
system.time(lapply(cityIds[3], function(cityId){
totalOffset(cityId) %>%
getHotelListLinks(cityId) %>%
lapply(function(url) getHotelLinksByPage(url, cityId)) %>%
unlist()
}))
system.time(lapply(cityIds[3], function(cityId){
totalOffset(cityId) %>%
getHotelListLinks(cityId) %>%
lapply(function(url) getHotelLinksByPage(url, cityId)) %>%
unlist()
}))
system.time(lapply(cityIds[3], function(cityId){
totalOffset(cityId) %>%
getHotelListLinks(cityId) %>%
lapply(function(url) getHotelLinksByPage(url, cityId)) %>%
unlist()
}))
system.time(lapply(cityIds[3], function(cityId){
totalOffset(cityId) %>%
getHotelListLinks(cityId) %>%
lapply(function(url) getHotelLinksByPage(url, cityId)) %>%
unlist()
}))
source('~/russia-clust/tripadvisor-methods.R')
getAllHotelLinks <- function(cityId) {
this.getHotelListLinks <- Curry(getHotelListLinks, cityId = cityId)
this.getHotelLinksByPage <- Curry(getHotelLinksByPage, cityId = cityId)
outputFun = Compose(totalOffset, this.getHotelListLinks, lapply(this.getHotelLinksByPage(url)))
return(outputFun(cityId))
}
getAllHotelLinks <- function(cityId) {
this.getHotelListLinks <- Curry(getHotelListLinks, cityId = cityId)
this.getHotelLinksByPage <- Curry(getHotelLinksByPage, cityId = cityId)
outputFun = Compose(totalOffset, this.getHotelListLinks, lapply(this.getHotelLinksByPage(url)), unlist)
return(outputFun(cityId))
}
getAllHotelLinks(cityIds[1])
getAllHotelLinks <- function(cityId) {
this.getHotelListLinks <- Curry(getHotelListLinks, cityId = cityId)
this.getHotelLinksByPage <- Curry(getHotelLinksByPage, cityId = cityId)
outputFun = Compose(totalOffset, this.getHotelListLinks, lapply(function(url) this.getHotelLinksByPage(url)), unlist)
return(outputFun(cityId))
}
getAllHotelLinks(cityIds[1])
getAllHotelLinks <- function(cityId) {
this.getHotelListLinks <- Curry(getHotelListLinks, cityId = cityId)
this.getHotelLinksByPage <- Curry(getHotelLinksByPage, cityId = cityId)
outputFun = Compose(totalOffset, this.getHotelListLinks, this.getHotelLinksByPage)
return(outputFun(cityId))
}
getAllHotelLinks(cityIds[1])
getAllHotelLinks(cityIds[1])
source('~/russia-clust/tripadvisor-methods.R')
rm(getAllHotelLinks())
rm(getAllHotelLinks
)
??xpath
links[[1]] %>% names
lapply(setNames(cityIds[3],cityIds[3]), function(cityId){
totalOffset(cityId) %>%
getHotelListLinks(cityId) %>%
lapply(function(url) getHotelLinksByPage(url, cityId)) %>%
unlist()
})
links = lapply(setNames(cityIds, cityIds), function(cityId){ #setNames is used to have named list; see http://stackoverflow.com/a/18520422/3818255
totalOffset(cityId) %>%
getHotelListLinks(cityId) %>%
lapply(function(url) getHotelLinksByPage(url, cityId)) %>%
unlist()
})
rm(links.test)
links$`298536`
links$`298536`[1]
links$`298536`[1] %>% names()
links$`298536`
source('~/russia-clust/tripadvisor-methods.R')
source('~/russia-clust/tripadvisor-methods.R')
?co
?cor
cor
?force
?assertthat
??assertthat
f = function(x, y) {
exists(y)
}
f(1)
rm(f)
urlConstructor <- function(cityId, hotelId, offset) {
if (missing(hotelId) {
if (missing(offset)) {
return(paste0("https://tripadvisor.ru/Hotels-g", cityId))
} else {
return(paste0("https://tripadvisor.ru/Hotels-g", cityId, "-oa", as.character(offset)))
}
} else {
if (missing(offset)) {
return(paste0("http://tripadvisor.ru/Hotel_Review-g", cityId, "-d", hotelId))
} else {
return (paste0("http://tripadvisor.ru/Hotel_Review-g", cityId, "-d", hotelId, "-or", offset))
}
}
}
urlConstructor <- function(cityId, hotelId, offset) {
if (missing(hotelId)) {
if (missing(offset)) {
return(paste0("https://tripadvisor.ru/Hotels-g", cityId))
} else {
return(paste0("https://tripadvisor.ru/Hotels-g", cityId, "-oa", as.character(offset)))
}
} else {
if (missing(offset)) {
return(paste0("http://tripadvisor.ru/Hotel_Review-g", cityId, "-d", hotelId))
} else {
return (paste0("http://tripadvisor.ru/Hotel_Review-g", cityId, "-d", hotelId, "-or", as.character(offset)))
}
}
}
urlConstructor(1, 20, 10)
urlConstructor(1, 10)
urlConstructor(1, offset = 10)
urlConstructor(10, offset = 10)
urlConstructor(10, 20, offset = 10)
urlConstructor(10, 20)
source('~/russia-clust/tripadvisor-methods.R')
urlConstructor <- function(cityId, hotelId, offset) {
if (missing(hotelId)) {
if (missing(offset)) {
return(paste0("https://tripadvisor.ru/Hotels-g", cityId))
} else {
return(paste0("https://tripadvisor.ru/Hotels-g", cityId, "-oa", as.character(offset)))
}
} else {
if (missing(offset)) {
return(paste0("http://tripadvisor.ru/Hotel_Review-g", cityId, "-d", hotelId))
} else {
return (paste0("http://tripadvisor.ru/Hotel_Review-g", cityId, "-d", hotelId, "-or", offset))
}
}
}
source('~/russia-clust/tripadvisor-methods.R')
links[[1]] %>% names
links[1] %>% names
lnks[1]
links[1]
urlConstructor(names(links[1]), names(links[[1]][1]), offset = 10)
urlConstructor(names(links[1]), names(links[[1]][1]), offset = 20)
?switch
?ifelse
?||
?`||`
urlConstructorUpd <- function(cityId, hotelId, offset) {
if (missing(offset)) {
if (missing(hoteliId)) {
type <- "c"
} else {
type <- "h"
}
} else {
if (missing(hoteliId)) {
type <- "co"
} else {
type <- "ho"
}
}
return(switch(
type,
c = paste0("https://tripadvisor.ru/Hotels-g", cityId),
h = paste0("http://tripadvisor.ru/Hotel_Review-g", cityId, "-d", hotelId),
co = paste0("https://tripadvisor.ru/Hotels-g", cityId, "-oa", as.character(offset)),
ho = paste0("http://tripadvisor.ru/Hotel_Review-g", cityId, "-d", hotelId, "-or", offset))
)
}
require(microbenchmark)
microbenchmark(urlConstructor(cityId = 1, hotelId = 1, offset = 1), urlConstructorUpd(cityId = 1, hotelId = 1, offset = 1))
urlConstructorUpd <- function(cityId, hotelId, offset) {
if (missing(offset)) {
if (missing(hoteliId)) {
type <- "c"
} else {
type <- "h"
}
} else {
if (missing(hotelId)) {
type <- "co"
} else {
type <- "ho"
}
}
return(switch(
type,
c = paste0("https://tripadvisor.ru/Hotels-g", cityId),
h = paste0("http://tripadvisor.ru/Hotel_Review-g", cityId, "-d", hotelId),
co = paste0("https://tripadvisor.ru/Hotels-g", cityId, "-oa", as.character(offset)),
ho = paste0("http://tripadvisor.ru/Hotel_Review-g", cityId, "-d", hotelId, "-or", offset))
)
}
microbenchmark(urlConstructor(cityId = 1, hotelId = 1, offset = 1), urlConstructorUpd(cityId = 1, hotelId = 1, offset = 1))
getTotalOffset <- function(cityId, hotelId) {
if (missing (hotelId)) {
#We check last pagination number on the page for "data-offset" property
offset <- urlConstructor(cityId = cityId) %>%
getNodesAttribute(xpath = "//*[@class = 'pageNum last taLnk']", attribute = "data-offset") %>%
as.numeric()
#If there is no pagination, which is possible, return 30
return(
ifelse(length(offset) > 0, offset, 30)
)
} else {
offset <- urlConstructor(cityId, hotelId) %>%
getNodesAttribute(xpath = "(//*[@class = 'pageNumbers']//a)[last()]", attribute = "data-offset") %>%
as.numeric()
return(
ifelse(length(offset) > 0, offset, 10)
)
}
}
getTotalOffset(298536)
getTotalOffset(298536, 6158220)
source('~/russia-clust/tripadvisor-methods.R')
source('~/russia-clust/tripadvisor-methods.R')
source('~/russia-clust/tripadvisor-methods.R')
step = 10
offset = 340
Reduce(function(x, y) x + y + step,
vector(mode = "numeric", length = offset / step),
accumulate = T,
init = 0)
rm(step, offset)
getOffsetLinks <- function(offset, cityId, hotelId = NULL) {
step = ifelse(is.null(hotelId), 30, 10)
Reduce(function(x, y) x + y + step,
vector(mode = "numeric", length = offset / step),
accumulate = T,
init = 0) %>%
#Afterwards we combine the vector of offsets into final urls
sapply(function(x) {
urlConstructor(cityId = cityId, hotelId = hotelId, offset = offset)
})
}
getOffsetLinks(340, 200, 987654)
debug(getOffsetLinks)
getOffsetLinks(340, 200, 987654)
getOffsetLinks(340, 200, 987654)
getOffsetLinks <- function(offset, cityId, hotelId = NULL) {
step = ifelse(is.null(hotelId), 30, 10)
Reduce(function(x, y) x + y + step,
vector(mode = "numeric", length = offset / step),
accumulate = T,
init = 0) %>%
#Afterwards we combine the vector of offsets into final urls
sapply(function(x) {
urlConstructor(cityId = cityId, hotelId = hotelId, offset = x)
})
}
undebug(getOffsetLinks)
getOffsetLinks(340, 200, 987654)
system("phantomjs a.js")
system("phantomjs a.js")
system("phantomjs a.js")
system("phantomjs a.js")
system("phantomjs a.js")
system("phantomjs b.js")
system("phantomjs b.js")
require(stringr)
string = "Кота заводят, чтобы кот
Был маяком во тьме забот —
Ты, например, забыл ключи,
Сын в школе двойку получил,
Прогнило у авто нутро,
Украли кошелек в метро,
А на работе вновь аврал,
Начальник матом наорал
И из-за кризиса в стране
Зарплату сократил вдвойне.
И ты пришел домой, а там
Припал больной душой к котам!
Кот нужен, чтобы вдохновлял
И биополем исцелял,
Мурлыкал громко под рукой,
Грел бок, гнал мышь, дарил покой,
Чтоб ты, кота погладив раз,
Лучился счастьем целый час!
На деле кот в ночи орет,
И будит, прыгнув на живот.
Прощайте, шторы и диван,
И тапки, если кот поган!
А если кот ваш волосат
То волосато все подряд!
Чуть отвернись — с тарелки гад
Всосет селедку и салат,
И будет маяться потом
Всенепременно животом.
Дешевый корм — на почках крест,
А дорогой корм кот не ест,
А если ест, опять вопрос:
То золотуха, то понос,
То ожиренье, то тошнит,
То блекнет шерсть, то хмурый вид.
Порой, для пущей лепоты,
В коте заводятся глисты,
И из лотка, как штурмотряд
С надеждой на тебя глядят!
Иль гость погладит дорогой
Кота немытою рукой,
И даже если кот привит —
Привет, лишай и энтерит!
Привет, леченья маета
Во все отверстия кота!
А кот свиреп, когтист, зубаст,
И жизнь без боя не отдаст!
Когда приходит Новый Год
Кот валит ель и дождик жрет
И в лучшем случае потом
Им развевает под хвостом,
А если вам не повезет
Совсем испортит Новый Год!
(Ведь мало у кого мечта —
Долбить могилу для кота).
Все нитки, иглы и шнурки
Закрыты крепко на замки,
Но, как ни прячь их, все равно,
Коту найти их суждено!
На раскаленную плиту
Никак нельзя не влезть коту,
А то и прыгнуть прямо в суп,
О стул с разбегу выбить зуб,
С буфета рухнув, поломать
Конечность или вашу мать!
Короче. Если кот ваш вдруг
Здоров сегодня и упруг,
Не бил хрусталь, не драл пальто,
Посрал чем надо и в лоток,
Все остальное — суета!
Погладь кота.
ПОГЛАДЬ КОТА!"
str_replace(string = string, pattern = "кот", replacement = "мыш")
str_replace_all(string = string, pattern = "кот", replacement = "мыш")
rm(string)
ls()
lsf.str()
setdiff(ls(), lsf.str())
!setdiff(ls(), lsf.str())
union(ls(), lsf.str())
setequal(ls(), lsf.str())
intersect(ls(), lsf.str())
rm(list = intersect(ls(), lsf.str()))
source('~/russia-clust/tripadvisor-methods.R')
rm(list = intersect(ls(), lsf.str()))
